<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Tomato Premium üçÖ</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-analytics-compat.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            /* Premium Dark Theme Colors */
            --bg-color: #050505;
            --accent-color: #FF4B2B; /* Vibrant Tomato Red */
            --accent-gradient: linear-gradient(135deg, #FF416C 0%, #FF4B2B 100%);
            --glass-bg: rgba(30, 30, 30, 0.6);
            --glass-border: rgba(255, 255, 255, 0.08);
            --text-primary: #ffffff;
            --text-secondary: #a0a0a0;
            --success: #00b894;
            --gold: #fdcb6e;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            font-family: 'Poppins', sans-serif;
        }

        body {
            background-color: var(--bg-color);
            background-image: 
                radial-gradient(circle at 10% 20%, rgba(255, 75, 43, 0.15) 0%, transparent 40%),
                radial-gradient(circle at 90% 80%, rgba(255, 65, 108, 0.1) 0%, transparent 40%);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
            padding-bottom: 90px; /* Space for bottom nav */
        }

        /* --- New Compact Header --- */
        .premium-header {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            padding: 12px 16px;
            background: rgba(5, 5, 5, 0.85);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            z-index: 100;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid var(--glass-border);
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }

        .header-user {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .header-avatar {
            width: 42px;
            height: 42px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid var(--accent-color);
            padding: 2px;
            background: transparent;
        }

        .header-info {
            line-height: 1.2;
        }

        .header-name {
            font-size: 15px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .header-level {
            font-size: 11px;
            color: var(--gold);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 700;
        }

        .header-balance {
            background: rgba(255, 255, 255, 0.1);
            padding: 6px 14px;
            border-radius: 20px;
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            border: 1px solid var(--glass-border);
        }

        .balance-val {
            font-size: 16px;
            font-weight: 700;
            color: var(--accent-color);
        }

        .balance-sub {
            font-size: 10px;
            color: var(--text-secondary);
        }

        /* --- Container & Pages --- */
        .container {
            padding: 80px 16px 20px 16px; /* Top padding for fixed header */
            max-width: 480px;
            margin: 0 auto;
        }

        .page {
            display: none;
            animation: slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1);
        }
        
        .page.active { display: block; }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* --- Premium Cards (Glassmorphism) --- */
        .glass-card {
            background: var(--glass-bg);
            border-radius: 24px;
            padding: 20px;
            margin-bottom: 16px;
            border: 1px solid var(--glass-border);
            position: relative;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        
        /* Shining Effect on Cards */
        .glass-card::before {
            content: '';
            position: absolute;
            top: 0; left: -100%;
            width: 100%; height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.05), transparent);
            transition: 0.5s;
        }
        .glass-card:hover::before { left: 100%; }

        .card-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .card-desc {
            font-size: 13px;
            color: var(--text-secondary);
            margin-bottom: 15px;
            line-height: 1.6;
        }

        /* --- Stats Grid --- */
        .stats-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 16px;
        }

        .stat-box {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 18px;
            padding: 15px;
            text-align: center;
            border: 1px solid var(--glass-border);
        }

        .stat-label {
            font-size: 11px;
            color: var(--text-secondary);
            text-transform: uppercase;
            margin-bottom: 5px;
        }

        .stat-val {
            font-size: 18px;
            font-weight: 700;
            color: var(--text-primary);
        }

        /* --- Daily Check-in (New Feature) --- */
        .daily-checkin {
            display: flex;
            justify-content: space-between;
            margin-top: 15px;
        }
        .day-circle {
            width: 35px; height: 35px;
            border-radius: 50%;
            background: rgba(255,255,255,0.05);
            display: flex; align-items: center; justify-content: center;
            font-size: 10px; font-weight: bold;
            color: var(--text-secondary);
            border: 1px solid var(--glass-border);
        }
        .day-circle.active {
            background: var(--accent-gradient);
            color: white;
            border: none;
            box-shadow: 0 4px 10px rgba(255, 75, 43, 0.4);
        }

        /* --- Buttons --- */
        .btn {
            width: 100%;
            padding: 16px;
            border: none;
            border-radius: 16px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .btn-primary {
            background: var(--accent-gradient);
            color: white;
            box-shadow: 0 8px 20px rgba(255, 75, 43, 0.3);
        }

        .btn-primary:active {
            transform: scale(0.98);
        }
        
        .btn-primary:disabled {
            opacity: 0.6;
            filter: grayscale(1);
        }

        .btn-glass {
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-primary);
            border: 1px solid var(--glass-border);
        }
        
        /* --- Task List --- */
        .task-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: rgba(255, 255, 255, 0.03);
            padding: 14px;
            border-radius: 16px;
            margin-bottom: 10px;
            border: 1px solid var(--glass-border);
        }
        
        .task-icon-box {
            width: 40px; height: 40px;
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.05);
            display: flex; align-items: center; justify-content: center;
            font-size: 20px;
            margin-right: 12px;
        }
        
        .task-info h4 { font-size: 14px; margin-bottom: 3px; }
        .task-info p { font-size: 11px; color: var(--accent-color); font-weight: 600; }
        
        .task-btn-sm {
            padding: 8px 16px;
            font-size: 12px;
            border-radius: 20px;
            background: var(--text-primary);
            color: black;
            border: none;
            font-weight: 600;
        }

        /* --- Form Inputs --- */
        .form-group { margin-bottom: 15px; }
        .form-label { font-size: 12px; color: var(--text-secondary); margin-bottom: 8px; display: block; }
        .form-input {
            width: 100%;
            background: rgba(0,0,0,0.3);
            border: 1px solid var(--glass-border);
            padding: 14px;
            border-radius: 14px;
            color: white;
            font-size: 14px;
            outline: none;
        }
        .form-input:focus { border-color: var(--accent-color); }

        /* --- Floating Bottom Navigation --- */
        .bottom-nav {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            width: 90%;
            max-width: 400px;
            background: rgba(20, 20, 20, 0.9);
            backdrop-filter: blur(20px);
            border-radius: 25px;
            display: flex;
            justify-content: space-around;
            padding: 12px 10px;
            border: 1px solid var(--glass-border);
            box-shadow: 0 10px 40px rgba(0,0,0,0.4);
            z-index: 999;
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            color: #666;
            transition: 0.3s;
            position: relative;
            padding: 0 10px;
        }

        .nav-item svg { width: 24px; height: 24px; margin-bottom: 4px; }
        .nav-item span { font-size: 10px; font-weight: 500; }

        .nav-item.active { color: var(--accent-color); }
        
        /* Active Indicator Dot */
        .nav-item.active::after {
            content: '';
            position: absolute;
            bottom: -5px;
            width: 4px; height: 4px;
            background: var(--accent-color);
            border-radius: 50%;
            box-shadow: 0 0 10px var(--accent-color);
        }

        /* --- Alerts & Modals --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); backdrop-filter: blur(5px);
            display: none; align-items: center; justify-content: center; z-index: 2000;
        }
        .modal-box {
            background: #151515;
            border: 1px solid var(--glass-border);
            padding: 30px;
            border-radius: 24px;
            width: 85%; max-width: 320px;
            text-align: center;
            transform: scale(0.9); opacity: 0;
            transition: 0.3s;
        }
        .modal-box.show { transform: scale(1); opacity: 1; }
        .modal-icon { font-size: 40px; margin-bottom: 15px; }

    </style>
</head>
<body>

    <div class="premium-header">
        <div class="header-user">
            <img id="headerAvatar" src="https://placehold.co/100x100/1a1a1a/FF4B2B?text=U" alt="Profile" class="header-avatar">
            <div class="header-info">
                <div class="header-name" id="headerName">Loading...</div>
                <div class="header-level" id="headerLevel">NOVICE</div>
            </div>
        </div>
        <div class="header-balance">
            <div class="balance-val" id="headerBalance">0</div>
            <div class="balance-sub">Points</div>
        </div>
    </div>

    <div class="container">

        <div id="homePage" class="page active">
            
            <div class="glass-card">
                <div class="card-title">
                    <span>üìÖ Daily Check-in</span>
                </div>
                <div class="daily-checkin" id="dailyCheckinList">
                    <div class="day-circle active">1</div>
                    <div class="day-circle">2</div>
                    <div class="day-circle">3</div>
                    <div class="day-circle">4</div>
                    <div class="day-circle">5</div>
                    <div class="day-circle">6</div>
                    <div class="day-circle">üéÅ</div>
                </div>
                <p class="card-desc" style="margin-top:15px; text-align:center; margin-bottom:0;">Login daily to earn bonus rewards!</p>
            </div>

            <div class="stats-row">
                <div class="stat-box">
                    <div class="stat-label">Daily Ads</div>
                    <div class="stat-val" id="statsDailyAds">0/0</div>
                </div>
                <div class="stat-box">
                    <div class="stat-label">Earnings</div>
                    <div class="stat-val" id="statsTotalEarn">0</div>
                </div>
            </div>
            
            <div class="stats-row">
                 <div class="stat-box">
                    <div class="stat-label">Refers</div>
                    <div class="stat-val" id="statsRefers">0</div>
                </div>
                <div class="stat-box">
                    <div class="stat-label">Total Views</div>
                    <div class="stat-val" id="statsTotalViews">0</div>
                </div>
            </div>

            <div class="glass-card" style="background: linear-gradient(145deg, rgba(255, 75, 43, 0.1), rgba(0,0,0,0)); border-color: var(--accent-color);">
                <div class="card-title" style="justify-content:center;">üöÄ Start Earning</div>
                <p class="card-desc" style="text-align:center;">Watch ads and complete tasks to level up.</p>
                <button class="btn btn-primary" onclick="navigateToPage('adsPage')">
                    Go to Tasks
                </button>
            </div>
        </div>

        <div id="adsPage" class="page">
             <div class="glass-card">
                 <div class="card-title">üì∫ Watch & Earn</div>
                 <p class="card-desc">High paying ads. Resets daily.</p>
                 
                 <div class="task-row">
                     <div style="display:flex; align-items:center;">
                         <div class="task-icon-box">‚ö°</div>
                         <div class="task-info">
                             <h4>Standard Ad</h4>
                             <p>+<span id="adPointsStd">0</span> Points</p>
                         </div>
                     </div>
                     <button class="task-btn-sm" id="btnStandardAd">Watch</button>
                 </div>

                 <div class="task-row">
                     <div style="display:flex; align-items:center;">
                         <div class="task-icon-box" style="background:rgba(255, 75, 43, 0.2); color:var(--accent-color);">üíé</div>
                         <div class="task-info">
                             <h4>Bonus Ad</h4>
                             <p>+<span id="adPointsBonus">0</span> Points</p>
                         </div>
                     </div>
                     <button class="task-btn-sm" id="btnBonusAd" style="background:var(--accent-gradient); color:white;">Claim</button>
                 </div>
             </div>

             <div class="glass-card">
                 <div class="card-title">üìù Extra Tasks</div>
                 <div id="dynamicTasksList">
                     </div>
             </div>
        </div>

        <div id="withdrawPage" class="page">
            <div class="glass-card" style="text-align: center;">
                <div style="font-size: 12px; color: var(--text-secondary);">Available Balance</div>
                <div style="font-size: 32px; font-weight: 700; color: white; margin: 10px 0;">
                    <span id="withdrawBalanceDisplay">0</span>
                </div>
                <div style="font-size: 12px; color: var(--success);">~ $<span id="withdrawUsdDisplay">0.00</span></div>
            </div>

            <div class="glass-card">
                <div class="card-title">Request Payout</div>
                
                <div class="form-group">
                    <label class="form-label">Select Method</label>
                    <select id="withdrawMethod" class="form-input" style="appearance: none;">
                        <option>Loading...</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label">Account Number</label>
                    <input type="text" id="withdrawAddress" class="form-input" placeholder="017xxxxxxxx">
                </div>

                <div class="form-group">
                    <label class="form-label">Amount</label>
                    <input type="number" id="withdrawAmountInput" class="form-input" placeholder="Min 5000">
                </div>

                <button class="btn btn-primary" id="btnSubmitWithdraw">Submit Request</button>
            </div>
            
            <div class="glass-card">
                <div class="card-title">History</div>
                <ul id="withdrawHistory" style="list-style:none; padding-left:0;"></ul>
            </div>
        </div>

        <div id="profilePage" class="page">
            <div class="glass-card" style="text-align: center;">
                <img id="profilePageAvatar" src="" class="header-avatar" style="width:80px; height:80px; margin-bottom:10px;">
                <h2 id="profilePageName" style="color:white; margin-bottom:5px;">User</h2>
                <div class="header-level" id="profilePageLevel" style="background: rgba(255,255,255,0.1); display:inline-block; padding:4px 10px; border-radius:10px;">NOVICE</div>
            </div>

            <div class="glass-card">
                <div class="card-title">ü§ù Invite Friends</div>
                <p class="card-desc">Earn <span id="referRateText">10%</span> from your friends.</p>
                
                <div style="background: rgba(0,0,0,0.3); padding: 10px; border-radius: 10px; font-family: monospace; color: var(--accent-color); word-break: break-all; margin-bottom: 10px;" id="referLinkBox">
                    Loading link...
                </div>
                
                <div style="display: flex; gap: 10px;">
                    <button class="btn btn-primary" id="btnCopyRef">Copy</button>
                    <button class="btn btn-glass" id="btnShareRef">Share</button>
                </div>
            </div>
            
             <div class="glass-card">
                <div class="card-title">üìû Support</div>
                <div id="supportList"></div>
            </div>
        </div>

    </div>

    <div class="bottom-nav">
        <div class="nav-item active" onclick="navigateToPage('homePage')">
            <svg viewBox="0 0 24 24" fill="currentColor"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/></svg>
            <span>Home</span>
        </div>
        <div class="nav-item" onclick="navigateToPage('adsPage')">
            <svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 14H9v-2h2v2zm0-4H9V7h2v5z"/></svg>
            <span>Tasks</span>
        </div>
        <div class="nav-item" onclick="navigateToPage('withdrawPage')">
            <svg viewBox="0 0 24 24" fill="currentColor"><path d="M21 18v1c0 1.1-.9 2-2 2H5c-1.11 0-2-.9-2-2V5c0-1.1.89-2 2-2h14c1.1 0 2 .9 2 2v1h-9c-1.11 0-2 .9-2 2v8c0 1.1.89 2 2 2h9zm-9-2h10V8H12v8zm4-2.5c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5z"/></svg>
            <span>Wallet</span>
        </div>
        <div class="nav-item" onclick="navigateToPage('profilePage')">
            <svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>
            <span>Profile</span>
        </div>
    </div>

    <div class="modal-overlay" id="customModal">
        <div class="modal-box" id="modalContent">
            <div class="modal-icon" id="modalIcon">üéâ</div>
            <h3 id="modalTitle" style="color:white; margin-bottom:10px;">Success</h3>
            <p id="modalMsg" style="color:var(--text-secondary); margin-bottom:20px; font-size:13px;">Operation completed.</p>
            <button class="btn btn-primary" onclick="closeModal()">Awesome</button>
        </div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.ready();
        tg.expand();
        // Theme Colors integration
        tg.setHeaderColor('#050505');
        tg.setBackgroundColor('#050505');

        // *** CONFIGURATION ***
        const BOT_USERNAME = "lal_tomatox_bot"; // Change this
        const SHORT_NAME = "app"; // Change this
        
        // *** FIREBASE CONFIG (Paste your own here) ***
        const firebaseConfig = {
            apiKey: "AIzaSyAolXMVYn7nLGUz4krYCHHgkBgkBRH4Djk",
            authDomain: "earnerx-506e1.firebaseapp.com",
            databaseURL: "https://earnerx-506e1-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "earnerx-506e1",
            storageBucket: "earnerx-506e1.firebasestorage.app",
            messagingSenderId: "868867404959",
            appId: "1:868867404959:web:c98447df696a9877bf5eaa"
        };
        
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        let currentUser = null;
        let appConfig = null;

        // --- Helper Functions ---
        function getLevel(points) {
            if (points > 50000) return "LEGEND";
            if (points > 20000) return "MASTER";
            if (points > 5000) return "PRO";
            return "NOVICE";
        }

        function formatPoints(num) {
            return num.toLocaleString();
        }

        function showModal(title, msg, icon = 'üéâ') {
            document.getElementById('modalTitle').innerText = title;
            document.getElementById('modalMsg').innerText = msg;
            document.getElementById('modalIcon').innerText = icon;
            const modal = document.getElementById('customModal');
            const box = document.getElementById('modalContent');
            modal.style.display = 'flex';
            setTimeout(() => box.classList.add('show'), 10);
            tg.HapticFeedback.notificationOccurred('success');
        }

        function closeModal() {
            const modal = document.getElementById('customModal');
            const box = document.getElementById('modalContent');
            box.classList.remove('show');
            setTimeout(() => modal.style.display = 'none', 300);
        }

        function navigateToPage(pageId) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(pageId).classList.add('active');
            
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
                if(item.getAttribute('onclick').includes(pageId)) {
                    item.classList.add('active');
                }
            });
            tg.HapticFeedback.selectionChanged();
        }

        // --- Core Logic ---
        
        // 1. Fetch Config
        async function fetchConfig() {
            const doc = await db.collection('config').doc('appConfig').get();
            if(doc.exists) {
                appConfig = doc.data();
                // Load Monetag if needed
                if(appConfig.monetagZoneId) loadMonetag(appConfig.monetagZoneId);
                updateUI();
            }
        }

        // 2. Monetag Loader
        function loadMonetag(zoneId) {
             const script = document.createElement('script');
             script.src = '//libtl.com/sdk.js';
             script.dataset.zone = zoneId;
             script.dataset.sdk = `show_${zoneId}`;
             document.head.appendChild(script);
        }

        function showAd(type = 'default') {
            return new Promise((resolve, reject) => {
                if(!appConfig?.monetagZoneId) return reject("No Ad Config");
                const func = window[`show_${appConfig.monetagZoneId}`];
                if(func) {
                    const p = type === 'pop' ? func('pop') : func();
                    p.then(resolve).catch(reject);
                } else {
                    reject("Ad SDK not ready");
                }
            });
        }

        // 3. UI Update
        function updateUI() {
            if(!currentUser || !appConfig) return;
            
            // Header
            const fullName = `${currentUser.first_name} ${currentUser.last_name || ''}`.trim();
            const level = getLevel(currentUser.balance);
            
            document.getElementById('headerName').innerText = fullName.substring(0, 15);
            document.getElementById('headerLevel').innerText = level;
            document.getElementById('headerBalance').innerText = formatPoints(currentUser.balance);
            document.getElementById('headerAvatar').src = currentUser.photo_url || "https://placehold.co/100x100/1a1a1a/FF4B2B?text=U";
            
            // Profile Page
            document.getElementById('profilePageName').innerText = fullName;
            document.getElementById('profilePageLevel').innerText = level;
            document.getElementById('profilePageAvatar').src = currentUser.photo_url || "https://placehold.co/100x100/1a1a1a/FF4B2B?text=U";

            // Home Stats
            document.getElementById('statsDailyAds').innerText = `${currentUser.dailyTasksCompleted || 0}/${appConfig.dailyTaskLimit || 10}`;
            document.getElementById('statsTotalEarn').innerText = formatPoints(currentUser.totalEarnings || 0);
            document.getElementById('statsRefers').innerText = currentUser.referredUsersCount || 0;
            document.getElementById('statsTotalViews').innerText = currentUser.totalTasksCompleted || 0;

            // Tasks Page Values
            document.getElementById('adPointsStd').innerText = appConfig.standardAdPoints || 10;
            document.getElementById('adPointsBonus').innerText = appConfig.bonusAdPoints || 20;
            
            // Wallet Page
            document.getElementById('withdrawBalanceDisplay').innerText = formatPoints(currentUser.balance);
            const rate = appConfig.dollarExchangeRate || 1000;
            document.getElementById('withdrawUsdDisplay').innerText = (currentUser.balance / rate).toFixed(2);
            
            // Render Lists
            renderMethods();
            renderHistory();
            renderDynamicTasks();
            renderSupport();
            
            // Refer
            const link = `https://t.me/${BOT_USERNAME}/${SHORT_NAME}?startapp=ref_${currentUser.userId}`;
            document.getElementById('referLinkBox').innerText = link;
            document.getElementById('referRateText').innerText = (appConfig.referralBonus > 0) ? `${appConfig.referralBonus} Pts` : `${appConfig.referralPercentage || 10}%`;
        }
        
        // --- Rendering Lists ---
        function renderMethods() {
            const sel = document.getElementById('withdrawMethod');
            sel.innerHTML = '';
            appConfig.paymentMethods?.forEach(m => {
                sel.innerHTML += `<option value="${m.id}">${m.name} (Min: ${m.minAmount})</option>`;
            });
        }

        async function renderHistory() {
            const list = document.getElementById('withdrawHistory');
            list.innerHTML = '';
            // Basic limit query
            const snap = await db.collection('withdrawals').where('userId', '==', currentUser.userId).orderBy('createdAt', 'desc').limit(5).get();
            if(snap.empty) { list.innerHTML = '<li style="text-align:center; color:#666; font-size:12px;">No history yet.</li>'; return; }
            
            snap.forEach(doc => {
                const d = doc.data();
                let color = '#fdcb6e'; // pending
                if(d.status === 'Approved') color = '#00b894';
                if(d.status === 'Rejected') color = '#ff7675';
                
                list.innerHTML += `
                <li style="display:flex; justify-content:space-between; margin-bottom:10px; border-bottom:1px solid rgba(255,255,255,0.05); padding-bottom:5px;">
                    <div>
                        <div style="font-size:13px; color:white;">${d.paymentMethodName}</div>
                        <div style="font-size:10px; color:#888;">${formatPoints(d.amount)} Pts</div>
                    </div>
                    <div style="font-size:11px; font-weight:bold; color:${color}; align-self:center;">${d.status}</div>
                </li>`;
            });
        }

        function renderDynamicTasks() {
            const div = document.getElementById('dynamicTasksList');
            div.innerHTML = '';
            appConfig.dynamicTasks?.forEach(task => {
                const today = new Date().toDateString();
                const isDone = (currentUser.completedTasks?.[task.id] === today) || (task.type === 'one-time' && currentUser.completedTasks?.[task.id] === 'completed');
                
                div.innerHTML += `
                 <div class="task-row">
                     <div style="display:flex; align-items:center;">
                         <div class="task-icon-box" style="background:#222; color:white;">üîó</div>
                         <div class="task-info">
                             <h4>${task.name}</h4>
                             <p>+${task.points} Pts</p>
                         </div>
                     </div>
                     <button class="task-btn-sm" onclick="doTask('${task.id}')" ${isDone ? 'disabled style="opacity:0.5"' : ''}>
                        ${isDone ? 'Done' : 'Start'}
                     </button>
                 </div>`;
            });
        }
        
        function renderSupport() {
             const div = document.getElementById('supportList');
             div.innerHTML = '';
             appConfig.supportLinks?.forEach(l => {
                 div.innerHTML += `
                 <div class="task-row" onclick="window.open('${l.link}')">
                     <div style="display:flex; align-items:center;">
                         <div class="task-icon-box">üí¨</div>
                         <h4>${l.name}</h4>
                     </div>
                     <span style="font-size:12px; color:var(--text-secondary);">Open ></span>
                 </div>`;
             });
        }

        // --- Actions ---
        
        document.getElementById('btnStandardAd').onclick = async function() {
            if(currentUser.dailyTasksCompleted >= appConfig.dailyTaskLimit) return showModal('Limit', 'Daily limit reached!', 'üõë');
            this.innerText = 'Loading...';
            try {
                await showAd('default');
                await rewardUser(appConfig.standardAdPoints, true);
            } catch(e) {
                console.log(e);
                showModal('Error', 'Ad failed to load.', '‚ùå');
            }
            this.innerText = 'Watch';
        };

        document.getElementById('btnBonusAd').onclick = async function() {
            if(currentUser.dailyTasksCompleted >= appConfig.dailyTaskLimit) return showModal('Limit', 'Daily limit reached!', 'üõë');
             this.innerText = '...';
            try {
                await showAd('pop');
                await rewardUser(appConfig.bonusAdPoints, true);
            } catch(e) {
                showModal('Error', 'Bonus ad unavailable.', '‚ùå');
            }
             this.innerText = 'Claim';
        };

        // Rewarding Logic
        async function rewardUser(points, isAd = false) {
             const ref = db.collection('users').doc(currentUser.userId);
             await db.runTransaction(async (t) => {
                 const doc = await t.get(ref);
                 const data = doc.data();
                 let update = {
                     balance: data.balance + points,
                     totalEarnings: data.totalEarnings + points
                 };
                 if(isAd) {
                     update.dailyTasksCompleted = (data.dailyTasksCompleted || 0) + 1;
                     update.totalTasksCompleted = (data.totalTasksCompleted || 0) + 1;
                 }
                 
                 // Refer Commission
                 if(data.referredBy && appConfig.referralPercentage > 0) {
                     const comm = Math.floor(points * (appConfig.referralPercentage / 100));
                     if(comm > 0) {
                         const refUser = db.collection('users').doc(data.referredBy);
                         t.update(refUser, { 
                             balance: firebase.firestore.FieldValue.increment(comm),
                             referralEarnings: firebase.firestore.FieldValue.increment(comm)
                         });
                     }
                 }
                 t.update(ref, update);
             });
             showModal('Awesome!', `You earned +${points} Points`, 'üí∞');
        }

        // Dynamic Task Logic
        window.doTask = function(taskId) {
            const task = appConfig.dynamicTasks.find(t => t.id === taskId);
            if(!task) return;
            tg.openLink(task.link);
            
            // Simple Timer Simulation
            showModal('Wait...', `Stay there for ${task.timer || 10} seconds`, '‚è≥');
            setTimeout(async () => {
                const ref = db.collection('users').doc(currentUser.userId);
                const today = new Date().toDateString();
                
                await ref.update({
                    balance: firebase.firestore.FieldValue.increment(task.points),
                    [`completedTasks.${taskId}`]: task.type === 'one-time' ? 'completed' : today
                });
                showModal('Done', `Task Reward: ${task.points}`, '‚úÖ');
            }, (task.timer || 10) * 1000);
        };
        
        // Withdraw Action
        document.getElementById('btnSubmitWithdraw').onclick = async function() {
            const amt = parseInt(document.getElementById('withdrawAmountInput').value);
            const addr = document.getElementById('withdrawAddress').value;
            const methodId = document.getElementById('withdrawMethod').value;
            
            if(!amt || !addr) return showModal('Error', 'Fill all fields', '‚ö†Ô∏è');
            if(amt > currentUser.balance) return showModal('Error', 'Insufficient Balance', 'üí∏');
            
            const method = appConfig.paymentMethods.find(m => m.id === methodId);
            if(amt < method.minAmount) return showModal('Error', `Min withdraw is ${method.minAmount}`, 'üìâ');

            try {
                await db.runTransaction(async (t) => {
                     const ref = db.collection('users').doc(currentUser.userId);
                     const doc = await t.get(ref);
                     if(doc.data().balance < amt) throw "Low Balance";
                     
                     t.update(ref, { balance: firebase.firestore.FieldValue.increment(-amt) });
                     const wRef = db.collection('withdrawals').doc();
                     t.set(wRef, {
                         userId: currentUser.userId,
                         amount: amt,
                         paymentAddress: addr,
                         paymentMethodName: method.name,
                         status: 'Pending',
                         createdAt: firebase.firestore.FieldValue.serverTimestamp()
                     });
                });
                showModal('Success', 'Withdrawal requested!', '‚úÖ');
                document.getElementById('withdrawAmountInput').value = '';
            } catch(e) {
                showModal('Error', 'Transaction failed', '‚ùå');
            }
        };
        
        // Copy Link
        document.getElementById('btnCopyRef').onclick = function() {
            const txt = document.getElementById('referLinkBox').innerText;
            navigator.clipboard.writeText(txt);
            showModal('Copied', 'Link copied to clipboard', 'üìã');
        };
        
        document.getElementById('btnShareRef').onclick = function() {
             const txt = document.getElementById('referLinkBox').innerText;
             tg.openTelegramLink(`https://t.me/share/url?url=${encodeURIComponent(txt)}&text=Join Now`);
        };


        // --- INIT ---
        const tgUser = tg.initDataUnsafe.user;
        if(tgUser) {
            const userId = String(tgUser.id);
            db.collection('users').doc(userId).onSnapshot(doc => {
                if(doc.exists) {
                    currentUser = doc.data();
                    // Reset daily check
                    if(currentUser.lastTaskDate !== new Date().toDateString()) {
                        db.collection('users').doc(userId).update({
                            dailyTasksCompleted: 0,
                            lastTaskDate: new Date().toDateString()
                        });
                    }
                    updateUI();
                } else {
                    // Create User
                    const newUser = {
                        userId: userId,
                        first_name: tgUser.first_name,
                        last_name: tgUser.last_name || '',
                        username: tgUser.username || '',
                        photo_url: tgUser.photo_url || '',
                        balance: 0,
                        totalEarnings: 0,
                        dailyTasksCompleted: 0,
                        lastTaskDate: new Date().toDateString(),
                        referredUsersCount: 0,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    };
                    
                    // Ref Logic
                    const startParam = tg.initDataUnsafe.start_param;
                    if(startParam && startParam.startsWith('ref_')) {
                        newUser.referredBy = startParam.split('_')[1];
                        // Increment referrer count logic here (simplified)
                        if(newUser.referredBy !== userId) {
                            db.collection('users').doc(newUser.referredBy).update({
                                referredUsersCount: firebase.firestore.FieldValue.increment(1)
                            });
                        }
                    }
                    
                    db.collection('users').doc(userId).set(newUser);
                }
            });
            fetchConfig();
        } else {
            document.body.innerHTML = "<h2 style='color:white;text-align:center;margin-top:50px;'>Open in Telegram</h2>";
        }

    </script>
</body>
</html>
